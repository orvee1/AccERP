import{u as st,r as c,j as t,B as D}from"./index-fe6d2e52.js";import{I as w}from"./input-e5a38bac.js";import{L as P}from"./label-1a727cef.js";import{D as nt}from"./date-picker-3c1e787d.js";import{S as F,a as C,b as R,c as T,d as A}from"./select-ae6383b7.js";import{T as H}from"./textarea-e623590e.js";import{C as it,a as dt,b as ot,c as lt,d as ct}from"./card-00c50818.js";import{R as ut}from"./rotate-ccw-4da8e8a6.js";import{T as mt}from"./trash-2-fd25eb8f.js";import{P as pt}from"./plus-circle-ee65b1db.js";import{S as W}from"./save-39dd484b.js";import"./extends-b7a1e135.js";const xt=[{id:"cust001",name:"Client Omega Corp."},{id:"cust002",name:"Customer Zeta Ltd."},{id:"cust003",name:"Patron Gamma Solutions"}],ht=()=>{const h=localStorage.getItem("products");if(h)try{return JSON.parse(h).map(b=>{var I;return{...b,units:((I=b.units)==null?void 0:I.map(k=>({...k,id:k.id||`${b.id}-${k.name}-${Date.now()}`})))||[],openingQuantity:b.isService?1/0:b.openingQuantity||0}})}catch(j){return console.error("Failed to parse products from localStorage",j),[]}return[{id:"PROD001",name:"Standard Widget",costingPrice:15.5,openingQuantity:100,isService:!1,units:[{id:`PROD001-pcs-${Date.now()}`,name:"pcs",factor:1,isBase:!0},{id:`PROD001-dozen-${Date.now()}`,name:"dozen",factor:12,isBase:!1}],baseUnitName:"pcs"}]},Pt=()=>{const{toast:h}=st(),[j,b]=c.useState(""),[I,k]=c.useState(new Date),[B,ft]=c.useState(`SRTN-${String(Date.now()).slice(-6)}`),[E,Z]=c.useState(""),[$,K]=c.useState(""),[L,z]=c.useState([]);c.useEffect(()=>{z(ht())},[]);const[p,Q]=c.useState([{id:Date.now(),productId:"",productDetails:null,quantityInput:1,quantityUnitId:"",quantityInBase:1,billingUnitId:"",rateForBillingUnit:0,discountPercent:0,discountAmount:0,totalPrice:0}]),[V,M]=c.useState(0),[X,Y]=c.useState("$0.00"),[v,_]=c.useState(0),[tt,et]=c.useState(0),N=c.useCallback(a=>{let s=parseFloat(a.quantityInput)||0;if(a.productDetails&&a.quantityUnitId&&a.productDetails.units){const e=a.productDetails.units.find(u=>u.id===a.quantityUnitId);e&&e.factor>0&&(s=(parseFloat(a.quantityInput)||0)*e.factor)}let n=0;if(a.productDetails&&a.billingUnitId&&a.productDetails.units){const e=a.productDetails.units.find(u=>u.id===a.billingUnitId);if(e&&e.factor>0){const u=(parseFloat(a.rateForBillingUnit)||0)/e.factor;n=s*u}}let i=0;parseFloat(a.discountAmount)>0?i=parseFloat(a.discountAmount):parseFloat(a.discountPercent)>0&&(i=n*(parseFloat(a.discountPercent)/100));const o=parseFloat((n-i).toFixed(2));return{...a,quantityInBase:s,totalPrice:o,itemRawTotal:n}},[]);c.useEffect(()=>{let a=0,s=0;p.map(i=>N(i)).forEach(i=>{a+=i.itemRawTotal||0,i.discountAmount>0?s+=i.discountAmount:i.discountPercent>0&&(s+=(i.itemRawTotal||0)*(i.discountPercent/100))}),M(parseFloat(a.toFixed(2))),Y(`-${s.toLocaleString("en-US",{style:"currency",currency:"USD"})}`)},[p,N]),c.useEffect(()=>{const a=p.reduce((n,i)=>{const o=N(i);let e=0;return o.discountAmount>0?e=o.discountAmount:o.discountPercent>0&&(e=(o.itemRawTotal||0)*(o.discountPercent/100)),n+e},0),s=V-a+v;et(parseFloat(s.toFixed(2)))},[V,v,p,N]);const at=()=>{Q([...p,{id:Date.now(),productId:"",productDetails:null,quantityInput:1,quantityUnitId:"",quantityInBase:1,billingUnitId:"",rateForBillingUnit:0,discountPercent:0,discountAmount:0,totalPrice:0}])},rt=a=>{Q(p.filter(s=>s.id!==a))},g=(a,s,n)=>{Q(i=>i.map(o=>{var r,l,x,S,U;if(o.id!==a)return o;let e={...o};if(s==="productId"){const d=L.find(m=>m.id===n);if(d){e.productId=n,e.productDetails=d;const m=(r=d.units)==null?void 0:r.find(f=>f.isBase);if(e.quantityUnitId=m?m.id:((x=(l=d.units)==null?void 0:l[0])==null?void 0:x.id)||"",e.billingUnitId=m?m.id:((U=(S=d.units)==null?void 0:S[0])==null?void 0:U.id)||"",m&&d.salesPrice){const f=d.units.find(q=>q.id===e.billingUnitId);e.rateForBillingUnit=(d.salesPrice||d.costingPrice||0)*((f==null?void 0:f.factor)||1)}else e.rateForBillingUnit=0;e.quantityInput=1}else e={...e,productId:"",productDetails:null,quantityUnitId:"",billingUnitId:"",rateForBillingUnit:0,quantityInput:1}}else if(s==="quantityUnitId"||s==="billingUnitId")e[s]=n;else if(s==="quantityInput")e.quantityInput=parseFloat(n)>=0?parseFloat(n):0;else if(s==="rateForBillingUnit")e[s]=parseFloat(n)||0;else if(s==="discountPercent"){const d=parseFloat(n)||0;e.discountPercent=d,d>0&&(e.discountAmount=0)}else if(s==="discountAmount"){const d=parseFloat(n)||0;e.discountAmount=d,d>0&&(e.discountPercent=0)}else e[s]=n;let u=parseFloat(e.quantityInput)||0;if(e.productDetails&&e.quantityUnitId&&e.productDetails.units){const d=e.productDetails.units.find(m=>m.id===e.quantityUnitId);d&&d.factor>0&&(u=(parseFloat(e.quantityInput)||0)*d.factor)}return e.quantityInBase=u,N(e)}))},O=(a=!1)=>{if(!j){h({title:"Validation Error",description:"Please select a customer.",variant:"destructive"});return}if(p.some(r=>!r.productId||r.totalPrice===0&&r.quantityInput>0)){h({title:"Validation Error",description:"Please ensure all line items have a product, valid quantity, units, and rate leading to a price.",variant:"destructive"});return}if(p.length===0||p.every(r=>r.quantityInput===0)){h({title:"Validation Error",description:"Cannot save an empty return or a return with all zero quantities.",variant:"destructive"});return}const s=p.filter(r=>r.quantityInput>0).map(r=>N(r));if(s.length===0){h({title:"Validation Error",description:"Cannot save a return with no valid line items.",variant:"destructive"});return}const n=s.reduce((r,l)=>r+(l.itemRawTotal||0),0),i=s.reduce((r,l)=>{let x=0;return l.discountAmount>0?x=l.discountAmount:l.discountPercent>0&&(x=(l.itemRawTotal||0)*(l.discountPercent/100)),r+x},0),o={customer:j,returnNumber:B,returnDate:I,lineItems:s.map(r=>{var l,x,S,U,d,m,f,q,J,G;return{productId:r.productId,productName:(l=r.productDetails)==null?void 0:l.name,quantityInput:r.quantityInput,quantityUnitId:r.quantityUnitId,quantityUnitName:(S=(x=r.productDetails)==null?void 0:x.units.find(y=>y.id===r.quantityUnitId))==null?void 0:S.name,quantityUnitFactor:(d=(U=r.productDetails)==null?void 0:U.units.find(y=>y.id===r.quantityUnitId))==null?void 0:d.factor,calculatedQuantityInBase:r.quantityInBase,baseUnitName:(m=r.productDetails)==null?void 0:m.baseUnitName,billingUnitId:r.billingUnitId,billingUnitName:(q=(f=r.productDetails)==null?void 0:f.units.find(y=>y.id===r.billingUnitId))==null?void 0:q.name,billingUnitFactor:(G=(J=r.productDetails)==null?void 0:J.units.find(y=>y.id===r.billingUnitId))==null?void 0:G.factor,rateForBillingUnit:r.rateForBillingUnit,discountPercent:r.discountPercent,discountAmount:r.discountAmount,itemRawTotal:r.itemRawTotal,calculatedPrice:r.totalPrice}}),subtotal:n,totalDiscount:i,taxAmount:v,grandTotal:n-i+v,notes:E,terms:$,isDraft:a};console.log("Sales Return Data: ",JSON.stringify(o,null,2));const e=JSON.parse(localStorage.getItem("salesReturns")||"[]");localStorage.setItem("salesReturns",JSON.stringify([...e,o]));const u=L.map(r=>{const l=o.lineItems.find(x=>x.productId===r.id);return l&&r.openingQuantity!==1/0?{...r,openingQuantity:r.openingQuantity+l.calculatedQuantityInBase}:r});localStorage.setItem("products",JSON.stringify(u)),z(u),h({title:"Sales Return Saved",description:`Return ${B} has been ${a?"saved as draft":"saved"}. Stock updated.`,className:"bg-green-100 dark:bg-green-800 text-green-700 dark:text-green-200 border-green-300 dark:border-green-600"})};return t.jsx("div",{className:"space-y-6 p-1 md:p-2",children:t.jsxs(it,{className:"shadow-xl border-border dark:border-dark-border bg-card dark:bg-dark-card",children:[t.jsx(dt,{className:"p-6 border-b border-border dark:border-dark-border",children:t.jsxs("div",{className:"flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4",children:[t.jsxs(ot,{className:"text-3xl font-bold text-primary dark:text-dark-primary flex items-center",children:[t.jsx(ut,{size:32,className:"mr-3 text-accent dark:text-dark-accent"})," New Sales Return"]}),t.jsx("div",{className:"text-muted-foreground dark:text-dark-muted-foreground font-mono text-sm bg-muted dark:bg-dark-muted px-2 py-1 rounded self-start sm:self-center",children:B})]})}),t.jsxs(lt,{className:"p-6 space-y-8",children:[t.jsxs("div",{className:"grid md:grid-cols-2 gap-6",children:[" ",t.jsxs("div",{className:"space-y-2",children:[t.jsxs(P,{htmlFor:"customer",className:"font-semibold",children:["Customer ",t.jsx("span",{className:"text-destructive dark:text-red-400",children:"*"})]}),t.jsxs(F,{onValueChange:b,value:j,children:[t.jsx(C,{id:"customer",children:t.jsx(R,{placeholder:"Select customer"})}),t.jsx(T,{children:xt.map(a=>t.jsx(A,{value:a.id,children:a.name},a.id))})]})]}),t.jsxs("div",{className:"space-y-2",children:[t.jsx(P,{htmlFor:"returnDate",className:"font-semibold",children:"Return Date"}),t.jsx(nt,{date:I,setDate:k})]})]}),t.jsxs("div",{className:"overflow-x-auto bg-background dark:bg-dark-background p-4 rounded-lg border border-border dark:border-dark-border shadow-inner",children:[t.jsxs("table",{className:"w-full min-w-[1300px]",children:[t.jsx("thead",{className:"border-b-2 border-primary dark:border-dark-primary",children:t.jsxs("tr",{children:[t.jsx("th",{className:"p-3 text-left text-sm font-semibold text-primary dark:text-dark-primary w-[18%]",children:"Product/Service"}),t.jsx("th",{className:"p-3 text-left text-sm font-semibold text-primary dark:text-dark-primary w-[7%]",children:"Quantity"}),t.jsx("th",{className:"p-3 text-left text-sm font-semibold text-primary dark:text-dark-primary w-[9%]",children:"Qty Unit"}),t.jsx("th",{className:"p-3 text-left text-sm font-semibold text-primary dark:text-dark-primary w-[11%]",children:"Rate (Billing Unit)"}),t.jsx("th",{className:"p-3 text-left text-sm font-semibold text-primary dark:text-dark-primary w-[11%]",children:"Billing Unit"}),t.jsx("th",{className:"p-3 text-left text-sm font-semibold text-primary dark:text-dark-primary w-[7%]",children:"Disc (%)"}),t.jsx("th",{className:"p-3 text-left text-sm font-semibold text-primary dark:text-dark-primary w-[9%]",children:"Disc Amt"}),t.jsx("th",{className:"p-3 text-right text-sm font-semibold text-primary dark:text-dark-primary w-[13%]",children:"Total Price"}),t.jsx("th",{className:"p-3 text-center text-sm font-semibold text-primary dark:text-dark-primary w-[5%]"})]})}),t.jsx("tbody",{children:p.map(a=>{var s,n,i,o;return t.jsxs("tr",{className:"border-b border-border dark:border-dark-border last:border-b-0 hover:bg-muted/50 dark:hover:bg-dark-muted/50 transition-colors",children:[t.jsx("td",{className:"p-2",children:t.jsxs(F,{value:a.productId,onValueChange:e=>g(a.id,"productId",e),children:[t.jsx(C,{className:"text-sm",children:t.jsx(R,{placeholder:"Select product"})}),t.jsx(T,{children:L.map(e=>t.jsx(A,{value:e.id,children:e.name},e.id))})]})}),t.jsx("td",{className:"p-2",children:t.jsx(w,{type:"number",value:a.quantityInput,onChange:e=>g(a.id,"quantityInput",e.target.value),placeholder:"1",className:"w-full text-sm",min:"0",step:"any"})}),t.jsx("td",{className:"p-2",children:t.jsxs(F,{value:a.quantityUnitId,onValueChange:e=>g(a.id,"quantityUnitId",e),disabled:!a.productDetails,children:[t.jsx(C,{className:"text-sm",children:t.jsx(R,{placeholder:"Unit"})}),t.jsx(T,{children:(n=(s=a.productDetails)==null?void 0:s.units)==null?void 0:n.map(e=>t.jsx(A,{value:e.id,children:e.name},e.id))})]})}),t.jsx("td",{className:"p-2",children:t.jsx(w,{type:"number",value:a.rateForBillingUnit,onChange:e=>g(a.id,"rateForBillingUnit",e.target.value),placeholder:"0.00",className:"w-full text-sm",min:"0",step:"0.01"})}),t.jsx("td",{className:"p-2",children:t.jsxs(F,{value:a.billingUnitId,onValueChange:e=>g(a.id,"billingUnitId",e),disabled:!a.productDetails,children:[t.jsx(C,{className:"text-sm",children:t.jsx(R,{placeholder:"Unit"})}),t.jsx(T,{children:(o=(i=a.productDetails)==null?void 0:i.units)==null?void 0:o.map(e=>{var u;return t.jsxs(A,{value:e.id,children:[e.name," (",e.factor," ",(u=a.productDetails)==null?void 0:u.baseUnitName,")"]},e.id)})})]})}),t.jsx("td",{className:"p-2",children:t.jsx(w,{type:"number",value:a.discountPercent,onChange:e=>g(a.id,"discountPercent",e.target.value),placeholder:"0",className:"w-full text-sm",min:"0",max:"100",disabled:!!a.discountAmount&&a.discountAmount>0})}),t.jsx("td",{className:"p-2",children:t.jsx(w,{type:"number",value:a.discountAmount,onChange:e=>g(a.id,"discountAmount",e.target.value),placeholder:"0.00",className:"w-full text-sm",min:"0",step:"0.01",disabled:!!a.discountPercent&&a.discountPercent>0})}),t.jsx("td",{className:"p-2 text-right text-sm font-medium",children:(a.totalPrice||0).toLocaleString("en-US",{style:"currency",currency:"USD"})}),t.jsx("td",{className:"p-2 text-center",children:t.jsx(D,{variant:"ghost",size:"icon",onClick:()=>rt(a.id),className:"text-destructive dark:text-red-400 hover:text-destructive/80 h-8 w-8",children:t.jsx(mt,{size:16})})})]},a.id)})})]}),t.jsxs(D,{onClick:at,variant:"outline",className:"mt-4 text-accent dark:text-dark-accent border-accent dark:border-dark-accent hover:bg-accent/10 dark:hover:bg-dark-accent/10 shadow-sm",children:[t.jsx(pt,{size:18,className:"mr-2"})," Add Line Item"]})]}),t.jsxs("div",{className:"grid md:grid-cols-2 gap-6 items-start",children:[t.jsxs("div",{children:[t.jsx(P,{htmlFor:"notes",className:"font-semibold",children:"Reason for Return/Notes"}),t.jsx(H,{id:"notes",value:E,onChange:a=>Z(a.target.value),placeholder:"Enter reason for return or other relevant notes...",className:"mt-1 min-h-[100px]"})]}),t.jsxs("div",{className:"space-y-3 p-4 bg-muted/70 dark:bg-dark-muted/70 rounded-lg shadow-inner border border-border dark:border-dark-border",children:[t.jsxs("div",{className:"flex justify-between items-center",children:[t.jsx("span",{className:"font-medium",children:"Subtotal:"}),t.jsx("span",{className:"font-semibold",children:V.toLocaleString("en-US",{style:"currency",currency:"USD"})})]}),t.jsxs("div",{className:"flex justify-between items-center",children:[t.jsx("span",{className:"font-medium",children:"Total Discount:"}),t.jsx("span",{className:"font-semibold text-green-600 dark:text-green-400",children:X})]}),t.jsxs("div",{className:"flex justify-between items-center",children:[t.jsx(P,{htmlFor:"taxAmountReturn",className:"font-medium",children:"Tax Refund/Adjustment:"}),t.jsx(w,{id:"taxAmountReturn",type:"number",value:v,onChange:a=>_(parseFloat(a.target.value)||0),placeholder:"0.00",className:"w-28 text-sm text-right",min:"0",step:"0.01"})]}),t.jsx("hr",{className:"border-border dark:border-dark-border my-2"}),t.jsxs("div",{className:"flex justify-between items-center text-xl text-primary dark:text-dark-primary font-bold",children:[t.jsx("span",{children:"Total Credit Due:"}),t.jsx("span",{children:tt.toLocaleString("en-US",{style:"currency",currency:"USD"})})]})]})]}),t.jsxs("div",{className:"space-y-2",children:[t.jsx(P,{htmlFor:"terms",className:"font-semibold",children:"Credit Note Terms"}),t.jsx(H,{id:"terms",value:$,onChange:a=>K(a.target.value),placeholder:"Enter terms for this credit note...",className:"mt-1 min-h-[100px]"})]})]}),t.jsxs(ct,{className:"bg-muted/30 dark:bg-dark-muted/30 rounded-b-lg p-6 flex flex-col sm:flex-row justify-end space-y-3 sm:space-y-0 sm:space-x-3 border-t border-border dark:border-dark-border",children:[t.jsx(D,{variant:"outline",className:"w-full sm:w-auto",onClick:()=>{},children:"Cancel"}),t.jsxs(D,{className:"w-full sm:w-auto bg-secondary text-secondary-foreground hover:bg-secondary-hover dark:bg-dark-secondary dark:text-dark-secondary-foreground dark:hover:bg-dark-secondary-hover flex items-center shadow hover:shadow-md",onClick:()=>O(!0),children:[t.jsx(W,{size:18,className:"mr-2"})," Save as Draft"]}),t.jsxs(D,{className:"w-full sm:w-auto bg-primary text-primary-foreground hover:bg-primary-hover dark:bg-dark-primary dark:text-dark-primary-foreground dark:hover:bg-dark-primary-hover flex items-center shadow hover:shadow-md",onClick:()=>O(!1),children:[t.jsx(W,{size:18,className:"mr-2"})," Save Return"]})]})]})})};export{Pt as default};
