import{u as et,r as u,j as t,B as S}from"./index-fe6d2e52.js";import{I as w}from"./input-e5a38bac.js";import{L as q}from"./label-1a727cef.js";import{D as at}from"./date-picker-3c1e787d.js";import{S as F,a as R,b as C,c as A,d as B}from"./select-ae6383b7.js";import{T as rt}from"./textarea-e623590e.js";import{C as nt,a as st,b as it,c as dt,d as ot}from"./card-00c50818.js";import{R as lt}from"./rotate-ccw-4da8e8a6.js";import{T as ct}from"./trash-2-fd25eb8f.js";import{P as ut}from"./plus-circle-ee65b1db.js";import{S as G}from"./save-39dd484b.js";import"./extends-b7a1e135.js";const mt=[{id:"vend001",name:"Supplier Alpha"},{id:"vend002",name:"Service Provider Beta"},{id:"vend003",name:"Materials Inc."}],pt=()=>{const h=localStorage.getItem("products");if(h)try{return JSON.parse(h).map(b=>{var k;return{...b,units:((k=b.units)==null?void 0:k.map(N=>({...N,id:N.id||`${b.id}-${N.name}-${Date.now()}`})))||[],openingQuantity:b.isService?1/0:b.openingQuantity||0}})}catch(j){return console.error("Failed to parse products from localStorage",j),[]}return[{id:"PROD001",name:"Standard Widget",costingPrice:15.5,openingQuantity:100,isService:!1,units:[{id:`PROD001-pcs-${Date.now()}`,name:"pcs",factor:1,isBase:!0},{id:`PROD001-dozen-${Date.now()}`,name:"dozen",factor:12,isBase:!1}],baseUnitName:"pcs"}]},St=()=>{const{toast:h}=et(),[j,b]=u.useState(""),[k,N]=u.useState(new Date),[T,xt]=u.useState(`PRTN-${String(Date.now()).slice(-6)}`),[E,H]=u.useState(""),[V,$]=u.useState([]);u.useEffect(()=>{$(pt())},[]);const[p,Q]=u.useState([{id:Date.now(),productId:"",productDetails:null,quantityInput:1,quantityUnitId:"",quantityInBase:1,billingUnitId:"",rateForBillingUnit:0,discountPercent:0,discountAmount:0,totalPrice:0}]),[L,M]=u.useState(0),[W,K]=u.useState("$0.00"),[v,X]=u.useState(0),[Y,Z]=u.useState(0),I=u.useCallback(a=>{let n=parseFloat(a.quantityInput)||0;if(a.productDetails&&a.quantityUnitId&&a.productDetails.units){const e=a.productDetails.units.find(c=>c.id===a.quantityUnitId);e&&e.factor>0&&(n=(parseFloat(a.quantityInput)||0)*e.factor)}let s=0;if(a.productDetails&&a.billingUnitId&&a.productDetails.units){const e=a.productDetails.units.find(c=>c.id===a.billingUnitId);if(e&&e.factor>0){const c=(parseFloat(a.rateForBillingUnit)||0)/e.factor;s=n*c}}let i=0;parseFloat(a.discountAmount)>0?i=parseFloat(a.discountAmount):parseFloat(a.discountPercent)>0&&(i=s*(parseFloat(a.discountPercent)/100));const o=parseFloat((s-i).toFixed(2));return{...a,quantityInBase:n,totalPrice:o,itemRawTotal:s}},[]);u.useEffect(()=>{let a=0,n=0;p.map(i=>I(i)).forEach(i=>{a+=i.itemRawTotal||0,i.discountAmount>0?n+=i.discountAmount:i.discountPercent>0&&(n+=(i.itemRawTotal||0)*(i.discountPercent/100))}),M(parseFloat(a.toFixed(2))),K(`-${n.toLocaleString("en-US",{style:"currency",currency:"USD"})}`)},[p,I]),u.useEffect(()=>{const a=p.reduce((s,i)=>{const o=I(i);let e=0;return o.discountAmount>0?e=o.discountAmount:o.discountPercent>0&&(e=(o.itemRawTotal||0)*(o.discountPercent/100)),s+e},0),n=L-a+v;Z(parseFloat(n.toFixed(2)))},[L,v,p,I]);const _=()=>{Q([...p,{id:Date.now(),productId:"",productDetails:null,quantityInput:1,quantityUnitId:"",quantityInBase:1,billingUnitId:"",rateForBillingUnit:0,discountPercent:0,discountAmount:0,totalPrice:0}])},tt=a=>{Q(p.filter(n=>n.id!==a))},g=(a,n,s)=>{Q(i=>i.map(o=>{var r,l,x,U,D;if(o.id!==a)return o;let e={...o};if(n==="productId"){const d=V.find(m=>m.id===s);if(d){e.productId=s,e.productDetails=d;const m=(r=d.units)==null?void 0:r.find(f=>f.isBase);if(e.quantityUnitId=m?m.id:((x=(l=d.units)==null?void 0:l[0])==null?void 0:x.id)||"",e.billingUnitId=m?m.id:((D=(U=d.units)==null?void 0:U[0])==null?void 0:D.id)||"",m&&d.costingPrice){const f=d.units.find(P=>P.id===e.billingUnitId);e.rateForBillingUnit=(d.costingPrice||0)*((f==null?void 0:f.factor)||1)}else e.rateForBillingUnit=0;e.quantityInput=1}else e={...e,productId:"",productDetails:null,quantityUnitId:"",billingUnitId:"",rateForBillingUnit:0,quantityInput:1}}else if(n==="quantityUnitId"||n==="billingUnitId")e[n]=s;else if(n==="quantityInput")e.quantityInput=parseFloat(s)>=0?parseFloat(s):0;else if(n==="rateForBillingUnit")e[n]=parseFloat(s)||0;else if(n==="discountPercent"){const d=parseFloat(s)||0;e.discountPercent=d,d>0&&(e.discountAmount=0)}else if(n==="discountAmount"){const d=parseFloat(s)||0;e.discountAmount=d,d>0&&(e.discountPercent=0)}else e[n]=s;let c=parseFloat(e.quantityInput)||0;if(e.productDetails&&e.quantityUnitId&&e.productDetails.units){const d=e.productDetails.units.find(m=>m.id===e.quantityUnitId);d&&d.factor>0&&(c=(parseFloat(e.quantityInput)||0)*d.factor)}return e.quantityInBase=c,I(e)}))},z=(a=!1)=>{if(!j){h({title:"Validation Error",description:"Please select a vendor.",variant:"destructive"});return}if(p.some(r=>!r.productId||r.totalPrice===0&&r.quantityInput>0)){h({title:"Validation Error",description:"Please ensure all line items have a product, valid quantity, units, and rate leading to a price.",variant:"destructive"});return}if(p.length===0||p.every(r=>r.quantityInput===0)){h({title:"Validation Error",description:"Cannot save an empty return or a return with all zero quantities.",variant:"destructive"});return}const n=p.filter(r=>r.quantityInput>0).map(r=>I(r));if(n.length===0){h({title:"Validation Error",description:"Cannot save a return with no valid line items.",variant:"destructive"});return}const s=n.reduce((r,l)=>r+(l.itemRawTotal||0),0),i=n.reduce((r,l)=>{let x=0;return l.discountAmount>0?x=l.discountAmount:l.discountPercent>0&&(x=(l.itemRawTotal||0)*(l.discountPercent/100)),r+x},0),o={vendor:j,returnNumber:T,returnDate:k,lineItems:n.map(r=>{var l,x,U,D,d,m,f,P,O,J;return{productId:r.productId,productName:(l=r.productDetails)==null?void 0:l.name,quantityInput:r.quantityInput,quantityUnitId:r.quantityUnitId,quantityUnitName:(U=(x=r.productDetails)==null?void 0:x.units.find(y=>y.id===r.quantityUnitId))==null?void 0:U.name,quantityUnitFactor:(d=(D=r.productDetails)==null?void 0:D.units.find(y=>y.id===r.quantityUnitId))==null?void 0:d.factor,calculatedQuantityInBase:r.quantityInBase,baseUnitName:(m=r.productDetails)==null?void 0:m.baseUnitName,billingUnitId:r.billingUnitId,billingUnitName:(P=(f=r.productDetails)==null?void 0:f.units.find(y=>y.id===r.billingUnitId))==null?void 0:P.name,billingUnitFactor:(J=(O=r.productDetails)==null?void 0:O.units.find(y=>y.id===r.billingUnitId))==null?void 0:J.factor,rateForBillingUnit:r.rateForBillingUnit,discountPercent:r.discountPercent,discountAmount:r.discountAmount,itemRawTotal:r.itemRawTotal,calculatedPrice:r.totalPrice}}),subtotal:s,totalDiscount:i,taxAmount:v,grandTotal:s-i+v,notes:E,isDraft:a};console.log("Purchase Return Data: ",JSON.stringify(o,null,2));const e=JSON.parse(localStorage.getItem("purchaseReturns")||"[]");localStorage.setItem("purchaseReturns",JSON.stringify([...e,o]));const c=V.map(r=>{const l=o.lineItems.find(x=>x.productId===r.id);return l&&r.openingQuantity!==1/0?{...r,openingQuantity:r.openingQuantity-l.calculatedQuantityInBase}:r});localStorage.setItem("products",JSON.stringify(c)),$(c),h({title:"Purchase Return Saved",description:`Return ${T} has been ${a?"saved as draft":"saved"}. Stock updated.`,className:"bg-green-100 dark:bg-green-800 text-green-700 dark:text-green-200 border-green-300 dark:border-green-600"})};return t.jsx("div",{className:"space-y-6 p-1 md:p-2",children:t.jsxs(nt,{className:"shadow-xl border-border dark:border-dark-border bg-card dark:bg-dark-card",children:[t.jsx(st,{className:"p-6 border-b border-border dark:border-dark-border",children:t.jsxs("div",{className:"flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4",children:[t.jsxs(it,{className:"text-3xl font-bold text-primary dark:text-dark-primary flex items-center",children:[t.jsx(lt,{size:32,className:"mr-3 text-accent dark:text-dark-accent"})," New Purchase Return"]}),t.jsx("div",{className:"text-muted-foreground dark:text-dark-muted-foreground font-mono text-sm bg-muted dark:bg-dark-muted px-2 py-1 rounded self-start sm:self-center",children:T})]})}),t.jsxs(dt,{className:"p-6 space-y-8",children:[t.jsxs("div",{className:"grid md:grid-cols-2 gap-6",children:[" ",t.jsxs("div",{className:"space-y-2",children:[t.jsxs(q,{htmlFor:"vendor",className:"font-semibold",children:["Vendor ",t.jsx("span",{className:"text-destructive dark:text-red-400",children:"*"})]}),t.jsxs(F,{onValueChange:b,value:j,children:[t.jsx(R,{id:"vendor",children:t.jsx(C,{placeholder:"Select vendor"})}),t.jsx(A,{children:mt.map(a=>t.jsx(B,{value:a.id,children:a.name},a.id))})]})]}),t.jsxs("div",{className:"space-y-2",children:[t.jsx(q,{htmlFor:"returnDate",className:"font-semibold",children:"Return Date"}),t.jsx(at,{date:k,setDate:N})]})]}),t.jsxs("div",{className:"overflow-x-auto bg-background dark:bg-dark-background p-4 rounded-lg border border-border dark:border-dark-border shadow-inner",children:[t.jsxs("table",{className:"w-full min-w-[1300px]",children:[t.jsx("thead",{className:"border-b-2 border-primary dark:border-dark-primary",children:t.jsxs("tr",{children:[t.jsx("th",{className:"p-3 text-left text-sm font-semibold text-primary dark:text-dark-primary w-[18%]",children:"Product/Service"}),t.jsx("th",{className:"p-3 text-left text-sm font-semibold text-primary dark:text-dark-primary w-[7%]",children:"Quantity"}),t.jsx("th",{className:"p-3 text-left text-sm font-semibold text-primary dark:text-dark-primary w-[9%]",children:"Qty Unit"}),t.jsx("th",{className:"p-3 text-left text-sm font-semibold text-primary dark:text-dark-primary w-[11%]",children:"Rate (Billing Unit)"}),t.jsx("th",{className:"p-3 text-left text-sm font-semibold text-primary dark:text-dark-primary w-[11%]",children:"Billing Unit"}),t.jsx("th",{className:"p-3 text-left text-sm font-semibold text-primary dark:text-dark-primary w-[7%]",children:"Disc (%)"}),t.jsx("th",{className:"p-3 text-left text-sm font-semibold text-primary dark:text-dark-primary w-[9%]",children:"Disc Amt"}),t.jsx("th",{className:"p-3 text-right text-sm font-semibold text-primary dark:text-dark-primary w-[13%]",children:"Total Price"}),t.jsx("th",{className:"p-3 text-center text-sm font-semibold text-primary dark:text-dark-primary w-[5%]"})]})}),t.jsx("tbody",{children:p.map(a=>{var n,s,i,o;return t.jsxs("tr",{className:"border-b border-border dark:border-dark-border last:border-b-0 hover:bg-muted/50 dark:hover:bg-dark-muted/50 transition-colors",children:[t.jsx("td",{className:"p-2",children:t.jsxs(F,{value:a.productId,onValueChange:e=>g(a.id,"productId",e),children:[t.jsx(R,{className:"text-sm",children:t.jsx(C,{placeholder:"Select product"})}),t.jsx(A,{children:V.map(e=>t.jsx(B,{value:e.id,children:e.name},e.id))})]})}),t.jsx("td",{className:"p-2",children:t.jsx(w,{type:"number",value:a.quantityInput,onChange:e=>g(a.id,"quantityInput",e.target.value),placeholder:"1",className:"w-full text-sm",min:"0",step:"any"})}),t.jsx("td",{className:"p-2",children:t.jsxs(F,{value:a.quantityUnitId,onValueChange:e=>g(a.id,"quantityUnitId",e),disabled:!a.productDetails,children:[t.jsx(R,{className:"text-sm",children:t.jsx(C,{placeholder:"Unit"})}),t.jsx(A,{children:(s=(n=a.productDetails)==null?void 0:n.units)==null?void 0:s.map(e=>t.jsx(B,{value:e.id,children:e.name},e.id))})]})}),t.jsx("td",{className:"p-2",children:t.jsx(w,{type:"number",value:a.rateForBillingUnit,onChange:e=>g(a.id,"rateForBillingUnit",e.target.value),placeholder:"0.00",className:"w-full text-sm",min:"0",step:"0.01"})}),t.jsx("td",{className:"p-2",children:t.jsxs(F,{value:a.billingUnitId,onValueChange:e=>g(a.id,"billingUnitId",e),disabled:!a.productDetails,children:[t.jsx(R,{className:"text-sm",children:t.jsx(C,{placeholder:"Unit"})}),t.jsx(A,{children:(o=(i=a.productDetails)==null?void 0:i.units)==null?void 0:o.map(e=>{var c;return t.jsxs(B,{value:e.id,children:[e.name," (",e.factor," ",(c=a.productDetails)==null?void 0:c.baseUnitName,")"]},e.id)})})]})}),t.jsx("td",{className:"p-2",children:t.jsx(w,{type:"number",value:a.discountPercent,onChange:e=>g(a.id,"discountPercent",e.target.value),placeholder:"0",className:"w-full text-sm",min:"0",max:"100",disabled:!!a.discountAmount&&a.discountAmount>0})}),t.jsx("td",{className:"p-2",children:t.jsx(w,{type:"number",value:a.discountAmount,onChange:e=>g(a.id,"discountAmount",e.target.value),placeholder:"0.00",className:"w-full text-sm",min:"0",step:"0.01",disabled:!!a.discountPercent&&a.discountPercent>0})}),t.jsx("td",{className:"p-2 text-right text-sm font-medium",children:(a.totalPrice||0).toLocaleString("en-US",{style:"currency",currency:"USD"})}),t.jsx("td",{className:"p-2 text-center",children:t.jsx(S,{variant:"ghost",size:"icon",onClick:()=>tt(a.id),className:"text-destructive dark:text-red-400 hover:text-destructive/80 h-8 w-8",children:t.jsx(ct,{size:16})})})]},a.id)})})]}),t.jsxs(S,{onClick:_,variant:"outline",className:"mt-4 text-accent dark:text-dark-accent border-accent dark:border-dark-accent hover:bg-accent/10 dark:hover:bg-dark-accent/10 shadow-sm",children:[t.jsx(ut,{size:18,className:"mr-2"})," Add Line Item"]})]}),t.jsxs("div",{className:"grid md:grid-cols-2 gap-6 items-start",children:[t.jsxs("div",{children:[t.jsx(q,{htmlFor:"notes",className:"font-semibold",children:"Reason for Return/Notes"}),t.jsx(rt,{id:"notes",value:E,onChange:a=>H(a.target.value),placeholder:"Enter reason for return or other relevant notes...",className:"mt-1 min-h-[100px]"})]}),t.jsxs("div",{className:"space-y-3 p-4 bg-muted/70 dark:bg-dark-muted/70 rounded-lg shadow-inner border border-border dark:border-dark-border",children:[t.jsxs("div",{className:"flex justify-between items-center",children:[t.jsx("span",{className:"font-medium",children:"Subtotal:"}),t.jsx("span",{className:"font-semibold",children:L.toLocaleString("en-US",{style:"currency",currency:"USD"})})]}),t.jsxs("div",{className:"flex justify-between items-center",children:[t.jsx("span",{className:"font-medium",children:"Total Discount:"}),t.jsx("span",{className:"font-semibold text-green-600 dark:text-green-400",children:W})]}),t.jsxs("div",{className:"flex justify-between items-center",children:[t.jsx(q,{htmlFor:"taxAmountReturn",className:"font-medium",children:"Tax Adjustment:"}),t.jsx(w,{id:"taxAmountReturn",type:"number",value:v,onChange:a=>X(parseFloat(a.target.value)||0),placeholder:"0.00",className:"w-28 text-sm text-right",min:"0",step:"0.01"})]}),t.jsx("hr",{className:"border-border dark:border-dark-border my-2"}),t.jsxs("div",{className:"flex justify-between items-center text-xl text-primary dark:text-dark-primary font-bold",children:[t.jsx("span",{children:"Total Credit:"}),t.jsx("span",{children:Y.toLocaleString("en-US",{style:"currency",currency:"USD"})})]})]})]})]}),t.jsxs(ot,{className:"bg-muted/30 dark:bg-dark-muted/30 rounded-b-lg p-6 flex flex-col sm:flex-row justify-end space-y-3 sm:space-y-0 sm:space-x-3 border-t border-border dark:border-dark-border",children:[t.jsx(S,{variant:"outline",className:"w-full sm:w-auto",onClick:()=>{},children:"Cancel"}),t.jsxs(S,{className:"w-full sm:w-auto bg-secondary text-secondary-foreground hover:bg-secondary-hover dark:bg-dark-secondary dark:text-dark-secondary-foreground dark:hover:bg-dark-secondary-hover flex items-center shadow hover:shadow-md",onClick:()=>z(!0),children:[t.jsx(G,{size:18,className:"mr-2"})," Save as Draft"]}),t.jsxs(S,{className:"w-full sm:w-auto bg-primary text-primary-foreground hover:bg-primary-hover dark:bg-dark-primary dark:text-dark-primary-foreground dark:hover:bg-dark-primary-hover flex items-center shadow hover:shadow-md",onClick:()=>z(!1),children:[t.jsx(G,{size:18,className:"mr-2"})," Save Return"]})]})]})})};export{St as default};
